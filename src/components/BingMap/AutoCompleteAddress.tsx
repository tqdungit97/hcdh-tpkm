import {
  ComponentProps,
  useEffect,
  useMemo,
  useRef,
  useState,
} from "react";
import {
  InputGroup,
  InputLeftElement,
  Input,
  Icon,
  InputRightElement,
} from "@chakra-ui/react";
import { MdClose, MdLocationPin } from "react-icons/md";
import { store } from "./store";

type AutoCompleteAddressProps = {
  id: string;
  disabled?: boolean;
  onChange: (sugestion?: Microsoft.Maps.ISuggestionResult) => void;
} & Omit<ComponentProps<typeof InputGroup>, "id" | "onChange">;

export function AutoCompleteAddress({
  id,
  disabled,
  onChange,
  ...props
}: AutoCompleteAddressProps) {
  const inputRef = useRef<HTMLInputElement>({} as HTMLInputElement);
  const containerRef = useRef<HTMLDivElement>({} as HTMLDivElement);
  const [map, setMap] = useState<Microsoft.Maps.Map>();

  const IDS = useMemo(
    () => ({
      container: id,
      input: `${id}_input`,
    }),
    [id]
  );

  const clear = () => {
    inputRef.current!.value = "";
    onChange(undefined);
  };

  useEffect(() => {
    store.subscribe(setMap);
  }, []);

  useEffect(() => {
    if (map) {
      Microsoft.Maps.loadModule("Microsoft.Maps.AutoSuggest", function () {
        const manager = new Microsoft.Maps.AutosuggestManager({
          map,
          maxResults: 4,
        });
        setTimeout(() => {
          manager.attachAutosuggest(
            `#${IDS.input}`,
            `#${IDS.container}`,
            onChange
          );
        }, 1000);
      });
    }
  }, [map, IDS, onChange]);

  return (
    <InputGroup
      id={IDS.container}
      ref={containerRef}
      w="full"
      {...props}
      bg="transparent"
      isolation="auto"
      sx={{
        ".MicrosoftMap": {
          width: "full",
          top: "100%",
          [`#as_containerSearch_${IDS.input}`]: {
            width: "full",
          },
          ".clear": {
            display: "none",
          },
        },
      }}
    >
      <InputLeftElement>
        <Icon as={MdLocationPin} />
      </InputLeftElement>
      <Input
        disabled={disabled}
        id={IDS.input}
        bg="white"
        placeholder="Bạn muốn đi đâu ?"
      />
      <InputRightElement onClick={clear}>
        <Icon as={MdClose} />
      </InputRightElement>
    </InputGroup>
  );
}
